#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
CS2 GSI Launcher - ĞŸÑ€Ğ¾ÑÑ‚Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ĞµĞ»ÑŒ Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµÑ‚ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ° (Ğ½Ğµ Ğ·Ñ€Ğ¸Ñ‚ĞµĞ»Ñ)
"""

import sys
import logging
from pathlib import Path

# Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒ Ñ€Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒÑĞºÑƒÑ Ğ¿Ğ°Ğ¿ĞºÑƒ Ğ² path
sys.path.insert(0, str(Path(__file__).parent))

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ğ›ĞĞ“Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ•
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - [%(name)s] - %(levelname)s - %(message)s'
)

logger = logging.getLogger(__name__)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ğ˜ĞœĞŸĞĞ Ğ¢Ğ«
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

try:
    from src.cs2_gsi import CS2GameStateIntegration, GameEvent
    logger.info("âœ… CS2 GSI Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾")
except Exception as e:
    logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ° cs2_gsi: {e}")
    sys.exit(1)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ğ¤Ğ˜Ğ›Ğ¬Ğ¢Ğ  Ğ¡ĞĞ‘Ğ«Ğ¢Ğ˜Ğ™ - Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‚Ğ²Ğ¾Ğ¸ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class PlayerEventFilter:
    """Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµÑ‚ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ, Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ° (Ğ½Ğµ Ğ·Ñ€Ğ¸Ñ‚ĞµĞ»Ñ)"""
    
    def __init__(self):
        self.player_team = None
    
    def is_player_event(self, event: GameEvent) -> bool:
        """
        ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ñ‡Ñ‚Ğ¾ ÑÑ‚Ğ¾ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°, Ğ° Ğ½Ğµ Ğ·Ñ€Ğ¸Ñ‚ĞµĞ»Ñ
        """
        # Ğ•ÑĞ»Ğ¸ ÑÑ‚Ğ¾ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ round_start Ğ¸Ğ»Ğ¸ round_end - Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ
        if event.event_type in ['round_start', 'round_end']:
            player_team = event.data.get('player_team', '')
            
            # Ğ•ÑĞ»Ğ¸ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ¿ÑƒÑÑ‚Ğ°Ñ - Ñ‚Ñ‹ Ğ·Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒ, Ğ¸Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼
            if not player_team or player_team == '':
                if event.event_type == 'round_start':
                    logger.warning("âš ï¸ [SPECTATOR MODE] Ğ¢Ñ‹ Ğ·Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒ - ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ½Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ÑÑ‚ÑÑ")
                return False
            
            # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ Ğ´Ğ»Ñ Ğ´Ğ°Ğ»ÑŒĞ½ĞµĞ¹ÑˆĞ¸Ñ… Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¾Ğº
            self.player_team = player_team
            return True
        
        # Ğ”Ğ»Ñ Ğ´Ñ€ÑƒĞ³Ğ¸Ñ… ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ - ĞµÑĞ»Ğ¸ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ±Ñ‹Ğ»Ğ° Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ°, ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ Ğ¸Ñ… Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğ¼Ğ¸
        # Ğ˜Ğ»Ğ¸ ĞµÑĞ»Ğ¸ ÑÑ‚Ğ¾ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ¸Ğ½Ñ„Ğ¾ Ğ¾ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğµ
        if 'player_team' in event.data and event.data['player_team'] == '':
            return False
        
        return True

event_filter = PlayerEventFilter()

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CALLBACK - Ñ‡Ñ‚Ğ¾ Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¸
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def handle_game_event(event: GameEvent):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ğ¸Ğ· CS2 (Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ¼ ÑĞ¿ĞµĞºÑ‚Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ²)"""
    
    # ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ ÑĞ¿ĞµĞºÑ‚Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ²
    if not event_filter.is_player_event(event):
        return
    
    logger.info(f"\n{'='*60}")
    logger.info(f"[ğŸ® EVENT] Ğ¢Ğ¸Ğ¿: {event.event_type}")
    logger.info(f"[ğŸ“Š DATA]  {event.data}")
    logger.info(f"[â±ï¸ TIME]  {event.timestamp}")
    logger.info(f"{'='*60}\n")

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ğ“Ğ›ĞĞ’ĞĞ«Ğ™ ĞšĞĞ”
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def main():
    logger.info("ğŸ® CS2 GSI LAUNCHER - Ğ—Ğ°Ğ¿ÑƒÑĞº")
    logger.info("="*60)
    logger.info("âš ï¸  [Ğ¤Ğ˜Ğ›Ğ¬Ğ¢Ğ ] Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ ÑĞ¿ĞµĞºÑ‚Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ² Ğ±ÑƒĞ´ÑƒÑ‚ Ğ¸Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ")
    logger.info("="*60)
    
    try:
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹ Ğ¸Ğ½ÑÑ‚Ğ°Ğ½Ñ GSI
        gsi = CS2GameStateIntegration(
            port=3000,
            event_callback=handle_game_event
        )
        
        # Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸ ÑĞµÑ€Ğ²ĞµÑ€
        gsi.start()
        
        logger.info("ğŸ® CS2 GSI Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ğ°")
        logger.info("ğŸ“ Ğ¡Ğ»ÑƒÑˆĞ°Ñ Ğ½Ğ° http://localhost:3000/")
        logger.info("â³ Ğ–Ğ´Ñƒ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ğ¸Ğ· CS2...")
        logger.info("ğŸ® Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¢Ğ« Ğ²Ğ¸Ğ´Ğ¸ÑˆÑŒ ÑÑ‚Ğ¸ Ğ»Ğ¾Ğ³Ğ¸ (ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ ÑĞ¿ĞµĞºÑ‚Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ² Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹)")
        logger.info("ğŸ›‘ Ğ”Ğ»Ñ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ° Ğ½Ğ°Ğ¶Ğ¼Ğ¸ Ctrl+C")
        logger.info("="*60)
        
        # Ğ‘ĞµÑĞºĞ¾Ğ½ĞµÑ‡Ğ½Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ» - ÑĞ»ÑƒÑˆĞ°ĞµĞ¼ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ
        import time
        while True:
            time.sleep(1)
    
    except KeyboardInterrupt:
        logger.info("\nğŸ›‘ Ğ’Ñ‹ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ...")
        gsi.stop()
        logger.info("âœ… GSI Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°")
    
    except Exception as e:
        logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ğ¢ĞĞ§ĞšĞ Ğ’Ğ¥ĞĞ”Ğ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if __name__ == '__main__':
    main()
